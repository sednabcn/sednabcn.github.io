name: Enhanced Sitemap Monitor & Status Reporter

on:
  schedule:
    - cron: '0 12 * * 1' # Run weekly on Mondays at 12:00 UTC
    - cron: '0 6 * * *'  # Daily health check at 6:00 UTC
  workflow_dispatch: # Allow manual triggering
    inputs:
      force_resubmit:
        description: 'Force resubmit all sitemaps'
        required: false
        default: 'false'
        type: boolean
      detailed_report:
        description: 'Generate detailed status report'
        required: false
        default: 'true'
        type: boolean

jobs:
  sitemap-status-monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth-oauthlib google-auth-httplib2
          pip install requests beautifulsoup4 lxml tabulate colorama
          pip install python-dateutil pytz

      - name: Setup service account credentials
        run: |
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT }}' > service-account.json
          chmod 600 service-account.json

      - name: Validate environment
        run: |
          echo "=== Environment Validation ==="
          python --version
          echo "Service account validation:"
          if [ -f "service-account.json" ]; then
            if python -c "import json; json.load(open('service-account.json'))" 2>/dev/null; then
<<<<<<< HEAD
               echo "‚úÖ Service account JSON is valid"
               python - <<'EOF'
import json
with open('service-account.json') as f:
          data = json.load(f)
          required_fields = ['type', 'project_id', 'private_key_id', 'private_key', 'client_email', 'client_id']
          missing = [field for field in required_fields if field not in data]
          if missing:
            print(f'‚ùå Missing required fields: {missing}')
            exit(1)
          else:
            print('‚úÖ All required service account fields present')
EOF
=======
              echo "‚úÖ Service account JSON is valid"
              python -c "
import json
with open('service-account.json') as f:
    data = json.load(f)
    required_fields = ['type', 'project_id', 'private_key_id', 'private_key', 'client_email', 'client_id']
    missing = [field for field in required_fields if field not in data]
    if missing:
        print(f'‚ùå Missing required fields: {missing}')
        exit(1)
    else:
        print('‚úÖ All required service account fields present')
"
>>>>>>> 509206bbc14ec3658bf0dde3eef59956659e6234
            else
              echo "‚ùå Service account JSON is invalid"
              exit 1
            fi
          else
<<<<<<< HEAD
             echo "‚ùå Service account file missing"
             exit 1
          fi    
          
      - name: Create enhanced sitemap monitoring script
        run: |
          cat > enhanced_sitemap_monitor.py << 'EOF'
          #!/usr/bin/env python3
          """
          Enhanced Sitemap Monitor with Status Reporting and Auto-Fix
          Monitors Google Search Console sitemap status and handles issues automatically
          """
          
          import os
          import sys
          import json
          import time
          import argparse
          from datetime import datetime, timezone, timedelta
          from typing import Dict, List, Optional, Tuple
          import requests
          from urllib.parse import urljoin, urlparse
          from pathlib import Path
          
          try:
              from google.oauth2 import service_account
              from googleapiclient.discovery import build
              from googleapiclient.errors import HttpError
              import xml.etree.ElementTree as ET
              from bs4 import BeautifulSoup
              import pytz
          except ImportError as e:
              print(f"‚ùå Missing required dependency: {e}")
              sys.exit(1)
          
          class SitemapMonitor:
              def __init__(self, service_account_path: str):
                  self.service_account_path = service_account_path
                  self.service = None
                  self.site_url = None
                  self.results = {
                      'timestamp': datetime.now(timezone.utc).isoformat(),
                      'site_url': None,
                      'sitemaps': [],
                      'issues_found': [],
                      'fixes_applied': [],
                      'summary': {}
                  }
          
              def authenticate(self) -> bool:
                  """Authenticate with Google Search Console API"""
                  try:
                      credentials = service_account.Credentials.from_service_account_file(
                          self.service_account_path,
                          scopes=['https://www.googleapis.com/auth/webmasters']
                      )
                      self.service = build('webmasters', 'v3', credentials=credentials)
                      print("‚úÖ Successfully authenticated with Google Search Console")
                      return True
                  except Exception as e:
                      print(f"‚ùå Authentication failed: {e}")
                      self.results['issues_found'].append(f"Authentication failed: {e}")
                      return False
          
              def validate_sitemap_url(self, sitemap_url: str) -> Tuple[bool, str]:
                  """Validate if sitemap URL is accessible and contains valid XML"""
                  try:
                      print(f"üîç Validating sitemap: {sitemap_url}")
                      response = requests.get(sitemap_url, timeout=30, headers={
                          'User-Agent': 'Googlebot/2.1 (+http://www.google.com/bot.html)'
                      })
                      
                      if response.status_code != 200:
                          return False, f"HTTP {response.status_code}: {response.reason}"
                      
                      # Check if it's valid XML
                      try:
                          root = ET.fromstring(response.content)
                          # Check if it's a sitemap or sitemap index
                          if root.tag.endswith('sitemapindex') or root.tag.endswith('urlset'):
                              url_count = len(root.findall('.//{http://www.sitemaps.org/schemas/sitemap/0.9}url'))
                              sitemap_count = len(root.findall('.//{http://www.sitemaps.org/schemas/sitemap/0.9}sitemap'))
                              
                              if url_count > 0:
                                  return True, f"Valid sitemap with {url_count} URLs"
                              elif sitemap_count > 0:
                                  return True, f"Valid sitemap index with {sitemap_count} sitemaps"
                              else:
                                  return False, "Sitemap contains no URLs or sub-sitemaps"
                          else:
                              return False, "Not a valid sitemap XML format"
                      except ET.ParseError as e:
                          return False, f"XML parsing error: {e}"
                          
                  except requests.RequestException as e:
                      return False, f"Request failed: {e}"
          
              def get_sitemap_status(self, site_url: str, sitemap_url: str) -> Dict:
                  """Get sitemap status from Google Search Console"""
                  try:
                      print(f"üìä Checking sitemap status: {sitemap_url}")
                      result = self.service.sitemaps().get(
                          siteUrl=site_url,
                          feedpath=sitemap_url
                      ).execute()
                      
                      return {
                          'url': sitemap_url,
                          'status': 'submitted',
                          'type': result.get('type', 'unknown'),
                          'isPending': result.get('isPending', False),
                          'isSitemapsIndex': result.get('isSitemapsIndex', False),
                          'submitted': result.get('submitted'),
                          'lastSubmitted': result.get('lastSubmitted'),
                          'lastDownloaded': result.get('lastDownloaded'),
                          'warnings': result.get('warnings', 0),
                          'errors': result.get('errors', 0),
                          'contents': result.get('contents', [])
                      }
                  except HttpError as e:
                      if e.resp.status == 404:
                          return {
                              'url': sitemap_url,
                              'status': 'not_submitted',
                              'error': 'Sitemap not found in Search Console'
                          }
                      else:
                          return {
                              'url': sitemap_url,
                              'status': 'error',
                              'error': f"API error: {e}"
                          }
          
              def submit_sitemap(self, site_url: str, sitemap_url: str) -> bool:
                  """Submit sitemap to Google Search Console"""
                  try:
                      print(f"üì§ Submitting sitemap: {sitemap_url}")
                      self.service.sitemaps().submit(
                          siteUrl=site_url,
                          feedpath=sitemap_url
                      ).execute()
                      print(f"‚úÖ Successfully submitted sitemap: {sitemap_url}")
                      self.results['fixes_applied'].append(f"Submitted sitemap: {sitemap_url}")
                      return True
                  except HttpError as e:
                      error_msg = f"Failed to submit sitemap {sitemap_url}: {e}"
                      print(f"‚ùå {error_msg}")
                      self.results['issues_found'].append(error_msg)
                      return False
          
              def delete_sitemap(self, site_url: str, sitemap_url: str) -> bool:
                  """Delete sitemap from Google Search Console"""
                  try:
                      print(f"üóëÔ∏è Deleting sitemap: {sitemap_url}")
                      self.service.sitemaps().delete(
                          siteUrl=site_url,
                          feedpath=sitemap_url
                      ).execute()
                      print(f"‚úÖ Successfully deleted sitemap: {sitemap_url}")
                      self.results['fixes_applied'].append(f"Deleted invalid sitemap: {sitemap_url}")
                      return True
                  except HttpError as e:
                      error_msg = f"Failed to delete sitemap {sitemap_url}: {e}"
                      print(f"‚ùå {error_msg}")
                      self.results['issues_found'].append(error_msg)
                      return False
          
              def monitor_sitemaps(self, site_url: str, sitemap_urls: List[str], force_resubmit: bool = False) -> Dict:
                  """Monitor and fix sitemap issues"""
                  self.site_url = site_url
                  self.results['site_url'] = site_url
                  
                  if not self.authenticate():
                      return self.results
                  
                  print(f"\nüåê Monitoring site: {site_url}")
                  print(f"üìã Checking {len(sitemap_urls)} sitemap(s)")
                  
                  for sitemap_url in sitemap_urls:
                      print(f"\n{'='*60}")
                      print(f"Processing: {sitemap_url}")
                      
                      # Validate sitemap accessibility
                      is_valid, validation_msg = self.validate_sitemap_url(sitemap_url)
                      
                      sitemap_result = {
                          'url': sitemap_url,
                          'validation': {
                              'is_valid': is_valid,
                              'message': validation_msg
                          }
                      }
                      
                      if not is_valid:
                          error_msg = f"Sitemap validation failed for {sitemap_url}: {validation_msg}"
                          print(f"‚ùå {error_msg}")
                          self.results['issues_found'].append(error_msg)
                          sitemap_result['status'] = 'validation_failed'
                          sitemap_result['action'] = 'none - invalid sitemap'
                      else:
                          print(f"‚úÖ Sitemap validation passed: {validation_msg}")
                          
                          # Get current status from Search Console
                          gsc_status = self.get_sitemap_status(site_url, sitemap_url)
                          sitemap_result.update(gsc_status)
                          
                          # Determine action needed
                          action_taken = self.determine_and_execute_action(
                              site_url, sitemap_url, gsc_status, force_resubmit
                          )
                          sitemap_result['action'] = action_taken
                      
                      self.results['sitemaps'].append(sitemap_result)
                  
                  # Generate summary
                  self.generate_summary()
                  return self.results
          
              def determine_and_execute_action(self, site_url: str, sitemap_url: str, 
                                             status: Dict, force_resubmit: bool) -> str:
                  """Determine what action to take and execute it"""
                  
                  if status['status'] == 'error':
                      return f"error - {status.get('error', 'unknown error')}"
                  
                  elif status['status'] == 'not_submitted' or force_resubmit:
                      if self.submit_sitemap(site_url, sitemap_url):
                          return 'submitted'
                      else:
                          return 'submission_failed'
                  
                  elif status['status'] == 'submitted':
                      # Check for issues
                      errors = status.get('errors', 0)
                      warnings = status.get('warnings', 0)
                      is_pending = status.get('isPending', False)
                      
                      if errors > 0:
                          error_msg = f"Sitemap {sitemap_url} has {errors} errors"
                          print(f"‚ö†Ô∏è {error_msg}")
                          self.results['issues_found'].append(error_msg)
                          
                          # Resubmit to try to fix errors
                          if self.submit_sitemap(site_url, sitemap_url):
                              return f're-submitted (had {errors} errors)'
                          else:
                              return f'resubmission_failed ({errors} errors)'
                      
                      elif warnings > 0:
                          warning_msg = f"Sitemap {sitemap_url} has {warnings} warnings"
                          print(f"‚ö†Ô∏è {warning_msg}")
                          self.results['issues_found'].append(warning_msg)
                          return f'ok_with_warnings ({warnings} warnings)'
                      
                      elif is_pending:
                          print(f"‚è≥ Sitemap {sitemap_url} is pending processing")
                          return 'pending_processing'
                      
                      else:
                          print(f"‚úÖ Sitemap {sitemap_url} is healthy")
                          return 'healthy'
                  
                  return 'unknown_status'
          
              def generate_summary(self):
                  """Generate summary statistics"""
                  total_sitemaps = len(self.results['sitemaps'])
                  healthy_count = sum(1 for s in self.results['sitemaps'] 
                                    if s.get('action') == 'healthy')
                  error_count = len(self.results['issues_found'])
                  fixes_count = len(self.results['fixes_applied'])
                  
                  self.results['summary'] = {
                      'total_sitemaps': total_sitemaps,
                      'healthy_sitemaps': healthy_count,
                      'issues_found': error_count,
                      'fixes_applied': fixes_count,
                      'overall_status': 'healthy' if error_count == 0 else 'issues_detected'
                  }
          
              def generate_report(self, detailed: bool = True) -> str:
                  """Generate human-readable report"""
                  summary = self.results['summary']
                  report = []
                  
                  report.append("# üó∫Ô∏è Sitemap Monitor Report")
                  report.append(f"**Generated:** {self.results['timestamp']}")
                  report.append(f"**Site:** {self.results['site_url']}")
                  report.append("")
                  
                  # Status badge
                  if summary['overall_status'] == 'healthy':
                      report.append("## üü¢ Overall Status: HEALTHY")
                  else:
                      report.append("## üî¥ Overall Status: ISSUES DETECTED")
                  
                  report.append("")
                  
                  # Summary stats
                  report.append("## üìä Summary")
                  report.append(f"- **Total Sitemaps:** {summary['total_sitemaps']}")
                  report.append(f"- **Healthy Sitemaps:** {summary['healthy_sitemaps']}")
                  report.append(f"- **Issues Found:** {summary['issues_found']}")
                  report.append(f"- **Fixes Applied:** {summary['fixes_applied']}")
                  report.append("")
                  
                  if detailed:
                      # Detailed sitemap status
                      report.append("## üìã Detailed Sitemap Status")
                      for sitemap in self.results['sitemaps']:
                          url = sitemap['url']
                          action = sitemap.get('action', 'unknown')
                          
                          if action == 'healthy':
                              status_emoji = "‚úÖ"
                          elif 'error' in action.lower() or 'failed' in action.lower():
                              status_emoji = "‚ùå"
                          elif 'warning' in action.lower():
                              status_emoji = "‚ö†Ô∏è"
                          else:
                              status_emoji = "‚ÑπÔ∏è"
                          
                          report.append(f"### {status_emoji} {url}")
                          report.append(f"**Action:** {action}")
                          
                          if 'validation' in sitemap:
                              val = sitemap['validation']
                              report.append(f"**Validation:** {'‚úÖ Valid' if val['is_valid'] else '‚ùå Invalid'} - {val['message']}")
                          
                          if 'lastDownloaded' in sitemap:
                              report.append(f"**Last Downloaded:** {sitemap['lastDownloaded']}")
                          
                          if 'errors' in sitemap and sitemap['errors'] > 0:
                              report.append(f"**Errors:** {sitemap['errors']}")
                          
                          if 'warnings' in sitemap and sitemap['warnings'] > 0:
                              report.append(f"**Warnings:** {sitemap['warnings']}")
                          
                          report.append("")
                  
                  # Issues section
                  if self.results['issues_found']:
                      report.append("## ‚ùå Issues Found")
                      for issue in self.results['issues_found']:
                          report.append(f"- {issue}")
                      report.append("")
                  
                  # Fixes section
                  if self.results['fixes_applied']:
                      report.append("## ‚úÖ Fixes Applied")
                      for fix in self.results['fixes_applied']:
                          report.append(f"- {fix}")
                      report.append("")
                  
                  # Recommendations
                  if self.results['issues_found']:
                      report.append("## üí° Recommendations")
                      report.append("1. Monitor the issues listed above")
                      report.append("2. Check your sitemap XML files for validity")
                      report.append("3. Ensure all URLs in sitemaps are accessible")
                      report.append("4. Review Google Search Console for additional details")
                      report.append("")
                  
                  return "\n".join(report)
          
          def main():
              parser = argparse.ArgumentParser(description='Enhanced Sitemap Monitor')
              parser.add_argument('--site', required=True, help='Site URL (e.g., https://example.com/)')
              parser.add_argument('--sitemaps', required=True, nargs='+', help='Sitemap URLs to monitor')
              parser.add_argument('--force-resubmit', action='store_true', help='Force resubmit all sitemaps')
              parser.add_argument('--detailed-report', action='store_true', default=True, help='Generate detailed report')
              parser.add_argument('--service-account', default='service-account.json', help='Service account JSON file')
              parser.add_argument('--output-json', help='Output results to JSON file')
              parser.add_argument('--output-report', help='Output report to markdown file')
              
              args = parser.parse_args()
              
              print("üöÄ Enhanced Sitemap Monitor Starting...")
              print(f"‚è∞ Timestamp: {datetime.now(timezone.utc).isoformat()}")
              
              monitor = SitemapMonitor(args.service_account)
              results = monitor.monitor_sitemaps(args.site, args.sitemaps, args.force_resubmit)
              
              # Output JSON results
              if args.output_json:
                  with open(args.output_json, 'w') as f:
                      json.dump(results, f, indent=2)
                  print(f"üìÑ Results saved to: {args.output_json}")
              
              # Generate and output report
              report = monitor.generate_report(args.detailed_report)
              print("\n" + "="*80)
              print(report)
              
              if args.output_report:
                  with open(args.output_report, 'w') as f:
                      f.write(report)
                  print(f"üìÑ Report saved to: {args.output_report}")
              
              # Set exit code based on results
              if results['summary']['overall_status'] != 'healthy':
                  print(f"\n‚ùå Exiting with error code 1 - Issues detected")
                  sys.exit(1)
              else:
                  print(f"\n‚úÖ All sitemaps healthy - Exiting with code 0")
                  sys.exit(0)
          
          if __name__ == '__main__':
              main()
          EOF

      - name: Run Enhanced Sitemap Monitor
        id: sitemap_check
        run: |
          python enhanced_sitemap_monitor.py \
            --site "https://sednabcn.github.io/" \
            --sitemaps "https://sednabcn.github.io/sitemap.xml" \
            --output-json "sitemap-results.json" \
            --output-report "sitemap-report.md" \
            ${{ inputs.force_resubmit == 'true' && '--force-resubmit' || '' }} \
            ${{ inputs.detailed_report == 'false' && '--no-detailed-report' || '--detailed-report' }}
        continue-on-error: true

      - name: Upload Results as Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: sitemap-monitor-results-${{ github.run_number }}
          path: |
            sitemap-results.json
            sitemap-report.md
          retention-days: 30

      - name: Check Results and Set Status
        id: check_results
        run: |
          if [ -f "sitemap-results.json" ]; then
            # Extract summary from JSON
            ISSUES_COUNT=$(python -c "import json; data=json.load(open('sitemap-results.json')); print(data['summary']['issues_found'])")
            FIXES_COUNT=$(python -c "import json; data=json.load(open('sitemap-results.json')); print(data['summary']['fixes_applied'])")
            OVERALL_STATUS=$(python -c "import json; data=json.load(open('sitemap-results.json')); print(data['summary']['overall_status'])")
            
            echo "issues_count=$ISSUES_COUNT" >> $GITHUB_OUTPUT
            echo "fixes_count=$FIXES_COUNT" >> $GITHUB_OUTPUT
            echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
            
            if [ "$OVERALL_STATUS" = "healthy" ]; then
              echo "‚úÖ All sitemaps are healthy!"
              echo "status_emoji=‚úÖ" >> $GITHUB_OUTPUT
              echo "status_message=All sitemaps healthy" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Issues detected in sitemaps!"
              echo "status_emoji=‚ùå" >> $GITHUB_OUTPUT
              echo "status_message=Issues detected - check report" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Results file not found!"
            echo "status_emoji=üí•" >> $GITHUB_OUTPUT
            echo "status_message=Monitor script failed" >> $GITHUB_OUTPUT
            echo "issues_count=1" >> $GITHUB_OUTPUT
            echo "fixes_count=0" >> $GITHUB_OUTPUT
            echo "overall_status=error" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Issue on Problems
        if: steps.check_results.outputs.overall_status != 'healthy'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const issueTitle = 'üó∫Ô∏è Sitemap Monitor: Issues Detected';
            const issuesCount = '${{ steps.check_results.outputs.issues_count }}';
            const fixesCount = '${{ steps.check_results.outputs.fixes_count }}';
            
            let reportContent = '## Summary\nReport generation failed - check workflow logs.';
            
            try {
              reportContent = fs.readFileSync('sitemap-report.md', 'utf8');
            } catch (error) {
              console.log('Could not read report file:', error.message);
            }
            
            const issueBody = `${reportContent}

---
**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
**Triggered by:** ${{ github.event_name }}
**Issues Found:** ${issuesCount}
**Fixes Applied:** ${fixesCount}

> This issue was automatically created by the Enhanced Sitemap Monitor workflow.`;

            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['sitemap-monitor', 'automated']
            });
            
            const existingIssue = issues.data.find(issue => issue.title === issueTitle);
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['sitemap-monitor', 'automated', 'bug']
              });
              console.log('Created new sitemap monitor issue');
            }

      - name: Close Issue if All Healthy
        if: steps.check_results.outputs.overall_status == 'healthy'
        uses: actions/github-script@v6
        with:
          script: |
            const issueTitle = 'üó∫Ô∏è Sitemap Monitor: Issues Detected';
            
            // Find open sitemap monitor issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['sitemap-monitor', 'automated']
            });
            
            const existingIssue = issues.data.find(issue => issue.title === issueTitle);
            
            if (existingIssue) {
              // Close the issue with a success comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `‚úÖ **All sitemap issues have been resolved!**

The latest sitemap monitor run shows all sitemaps are now healthy.

**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
**Status:** All sitemaps healthy
**Fixes Applied:** ${{ steps.check_results.outputs.fixes_count }}

Automatically closing this issue.`
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                state: 'closed'
              });
              console.log(`Closed resolved issue #${existingIssue.number}`);
            }

      - name: Update Repository Status Badge
        run: |
=======
            echo "‚ùå Service account file missing"
            exit 1
          fi

      - name: Create enhanced sitemap monitoring script
        run: |
          cat > enhanced_sitemap_monitor.py << 'EOF'
          #!/usr/bin/env python3
          """
          Enhanced Sitemap Monitor with Status Reporting and Auto-Fix
          Monitors Google Search Console sitemap status and handles issues automatically
          """
          
          import os
          import sys
          import json
          import time
          import argparse
          from datetime import datetime, timezone, timedelta
          from typing import Dict, List, Optional, Tuple
          import requests
          from urllib.parse import urljoin, urlparse
          from pathlib import Path
          
          try:
              from google.oauth2 import service_account
              from googleapiclient.discovery import build
              from googleapiclient.errors import HttpError
              import xml.etree.ElementTree as ET
              from bs4 import BeautifulSoup
              import pytz
          except ImportError as e:
              print(f"‚ùå Missing required dependency: {e}")
              sys.exit(1)
          
          class SitemapMonitor:
              def __init__(self, service_account_path: str):
                  self.service_account_path = service_account_path
                  self.service = None
                  self.site_url = None
                  self.results = {
                      'timestamp': datetime.now(timezone.utc).isoformat(),
                      'site_url': None,
                      'sitemaps': [],
                      'issues_found': [],
                      'fixes_applied': [],
                      'summary': {}
                  }
          
              def authenticate(self) -> bool:
                  """Authenticate with Google Search Console API"""
                  try:
                      credentials = service_account.Credentials.from_service_account_file(
                          self.service_account_path,
                          scopes=['https://www.googleapis.com/auth/webmasters']
                      )
                      self.service = build('webmasters', 'v3', credentials=credentials)
                      print("‚úÖ Successfully authenticated with Google Search Console")
                      return True
                  except Exception as e:
                      print(f"‚ùå Authentication failed: {e}")
                      self.results['issues_found'].append(f"Authentication failed: {e}")
                      return False
          
              def validate_sitemap_url(self, sitemap_url: str) -> Tuple[bool, str]:
                  """Validate if sitemap URL is accessible and contains valid XML"""
                  try:
                      print(f"üîç Validating sitemap: {sitemap_url}")
                      response = requests.get(sitemap_url, timeout=30, headers={
                          'User-Agent': 'Googlebot/2.1 (+http://www.google.com/bot.html)'
                      })
                      
                      if response.status_code != 200:
                          return False, f"HTTP {response.status_code}: {response.reason}"
                      
                      # Check if it's valid XML
                      try:
                          root = ET.fromstring(response.content)
                          # Check if it's a sitemap or sitemap index
                          if root.tag.endswith('sitemapindex') or root.tag.endswith('urlset'):
                              url_count = len(root.findall('.//{http://www.sitemaps.org/schemas/sitemap/0.9}url'))
                              sitemap_count = len(root.findall('.//{http://www.sitemaps.org/schemas/sitemap/0.9}sitemap'))
                              
                              if url_count > 0:
                                  return True, f"Valid sitemap with {url_count} URLs"
                              elif sitemap_count > 0:
                                  return True, f"Valid sitemap index with {sitemap_count} sitemaps"
                              else:
                                  return False, "Sitemap contains no URLs or sub-sitemaps"
                          else:
                              return False, "Not a valid sitemap XML format"
                      except ET.ParseError as e:
                          return False, f"XML parsing error: {e}"
                          
                  except requests.RequestException as e:
                      return False, f"Request failed: {e}"
          
              def get_sitemap_status(self, site_url: str, sitemap_url: str) -> Dict:
                  """Get sitemap status from Google Search Console"""
                  try:
                      print(f"üìä Checking sitemap status: {sitemap_url}")
                      result = self.service.sitemaps().get(
                          siteUrl=site_url,
                          feedpath=sitemap_url
                      ).execute()
                      
                      return {
                          'url': sitemap_url,
                          'status': 'submitted',
                          'type': result.get('type', 'unknown'),
                          'isPending': result.get('isPending', False),
                          'isSitemapsIndex': result.get('isSitemapsIndex', False),
                          'submitted': result.get('submitted'),
                          'lastSubmitted': result.get('lastSubmitted'),
                          'lastDownloaded': result.get('lastDownloaded'),
                          'warnings': result.get('warnings', 0),
                          'errors': result.get('errors', 0),
                          'contents': result.get('contents', [])
                      }
                  except HttpError as e:
                      if e.resp.status == 404:
                          return {
                              'url': sitemap_url,
                              'status': 'not_submitted',
                              'error': 'Sitemap not found in Search Console'
                          }
                      else:
                          return {
                              'url': sitemap_url,
                              'status': 'error',
                              'error': f"API error: {e}"
                          }
          
              def submit_sitemap(self, site_url: str, sitemap_url: str) -> bool:
                  """Submit sitemap to Google Search Console"""
                  try:
                      print(f"üì§ Submitting sitemap: {sitemap_url}")
                      self.service.sitemaps().submit(
                          siteUrl=site_url,
                          feedpath=sitemap_url
                      ).execute()
                      print(f"‚úÖ Successfully submitted sitemap: {sitemap_url}")
                      self.results['fixes_applied'].append(f"Submitted sitemap: {sitemap_url}")
                      return True
                  except HttpError as e:
                      error_msg = f"Failed to submit sitemap {sitemap_url}: {e}"
                      print(f"‚ùå {error_msg}")
                      self.results['issues_found'].append(error_msg)
                      return False
          
              def delete_sitemap(self, site_url: str, sitemap_url: str) -> bool:
                  """Delete sitemap from Google Search Console"""
                  try:
                      print(f"üóëÔ∏è Deleting sitemap: {sitemap_url}")
                      self.service.sitemaps().delete(
                          siteUrl=site_url,
                          feedpath=sitemap_url
                      ).execute()
                      print(f"‚úÖ Successfully deleted sitemap: {sitemap_url}")
                      self.results['fixes_applied'].append(f"Deleted invalid sitemap: {sitemap_url}")
                      return True
                  except HttpError as e:
                      error_msg = f"Failed to delete sitemap {sitemap_url}: {e}"
                      print(f"‚ùå {error_msg}")
                      self.results['issues_found'].append(error_msg)
                      return False
          
              def monitor_sitemaps(self, site_url: str, sitemap_urls: List[str], force_resubmit: bool = False) -> Dict:
                  """Monitor and fix sitemap issues"""
                  self.site_url = site_url
                  self.results['site_url'] = site_url
                  
                  if not self.authenticate():
                      return self.results
                  
                  print(f"\nüåê Monitoring site: {site_url}")
                  print(f"üìã Checking {len(sitemap_urls)} sitemap(s)")
                  
                  for sitemap_url in sitemap_urls:
                      print(f"\n{'='*60}")
                      print(f"Processing: {sitemap_url}")
                      
                      # Validate sitemap accessibility
                      is_valid, validation_msg = self.validate_sitemap_url(sitemap_url)
                      
                      sitemap_result = {
                          'url': sitemap_url,
                          'validation': {
                              'is_valid': is_valid,
                              'message': validation_msg
                          }
                      }
                      
                      if not is_valid:
                          error_msg = f"Sitemap validation failed for {sitemap_url}: {validation_msg}"
                          print(f"‚ùå {error_msg}")
                          self.results['issues_found'].append(error_msg)
                          sitemap_result['status'] = 'validation_failed'
                          sitemap_result['action'] = 'none - invalid sitemap'
                      else:
                          print(f"‚úÖ Sitemap validation passed: {validation_msg}")
                          
                          # Get current status from Search Console
                          gsc_status = self.get_sitemap_status(site_url, sitemap_url)
                          sitemap_result.update(gsc_status)
                          
                          # Determine action needed
                          action_taken = self.determine_and_execute_action(
                              site_url, sitemap_url, gsc_status, force_resubmit
                          )
                          sitemap_result['action'] = action_taken
                      
                      self.results['sitemaps'].append(sitemap_result)
                  
                  # Generate summary
                  self.generate_summary()
                  return self.results
          
              def determine_and_execute_action(self, site_url: str, sitemap_url: str, 
                                             status: Dict, force_resubmit: bool) -> str:
                  """Determine what action to take and execute it"""
                  
                  if status['status'] == 'error':
                      return f"error - {status.get('error', 'unknown error')}"
                  
                  elif status['status'] == 'not_submitted' or force_resubmit:
                      if self.submit_sitemap(site_url, sitemap_url):
                          return 'submitted'
                      else:
                          return 'submission_failed'
                  
                  elif status['status'] == 'submitted':
                      # Check for issues
                      errors = status.get('errors', 0)
                      warnings = status.get('warnings', 0)
                      is_pending = status.get('isPending', False)
                      
                      if errors > 0:
                          error_msg = f"Sitemap {sitemap_url} has {errors} errors"
                          print(f"‚ö†Ô∏è {error_msg}")
                          self.results['issues_found'].append(error_msg)
                          
                          # Resubmit to try to fix errors
                          if self.submit_sitemap(site_url, sitemap_url):
                              return f're-submitted (had {errors} errors)'
                          else:
                              return f'resubmission_failed ({errors} errors)'
                      
                      elif warnings > 0:
                          warning_msg = f"Sitemap {sitemap_url} has {warnings} warnings"
                          print(f"‚ö†Ô∏è {warning_msg}")
                          self.results['issues_found'].append(warning_msg)
                          return f'ok_with_warnings ({warnings} warnings)'
                      
                      elif is_pending:
                          print(f"‚è≥ Sitemap {sitemap_url} is pending processing")
                          return 'pending_processing'
                      
                      else:
                          print(f"‚úÖ Sitemap {sitemap_url} is healthy")
                          return 'healthy'
                  
                  return 'unknown_status'
          
              def generate_summary(self):
                  """Generate summary statistics"""
                  total_sitemaps = len(self.results['sitemaps'])
                  healthy_count = sum(1 for s in self.results['sitemaps'] 
                                    if s.get('action') == 'healthy')
                  error_count = len(self.results['issues_found'])
                  fixes_count = len(self.results['fixes_applied'])
                  
                  self.results['summary'] = {
                      'total_sitemaps': total_sitemaps,
                      'healthy_sitemaps': healthy_count,
                      'issues_found': error_count,
                      'fixes_applied': fixes_count,
                      'overall_status': 'healthy' if error_count == 0 else 'issues_detected'
                  }
          
              def generate_report(self, detailed: bool = True) -> str:
                  """Generate human-readable report"""
                  summary = self.results['summary']
                  report = []
                  
                  report.append("# üó∫Ô∏è Sitemap Monitor Report")
                  report.append(f"**Generated:** {self.results['timestamp']}")
                  report.append(f"**Site:** {self.results['site_url']}")
                  report.append("")
                  
                  # Status badge
                  if summary['overall_status'] == 'healthy':
                      report.append("## üü¢ Overall Status: HEALTHY")
                  else:
                      report.append("## üî¥ Overall Status: ISSUES DETECTED")
                  
                  report.append("")
                  
                  # Summary stats
                  report.append("## üìä Summary")
                  report.append(f"- **Total Sitemaps:** {summary['total_sitemaps']}")
                  report.append(f"- **Healthy Sitemaps:** {summary['healthy_sitemaps']}")
                  report.append(f"- **Issues Found:** {summary['issues_found']}")
                  report.append(f"- **Fixes Applied:** {summary['fixes_applied']}")
                  report.append("")
                  
                  if detailed:
                      # Detailed sitemap status
                      report.append("## üìã Detailed Sitemap Status")
                      for sitemap in self.results['sitemaps']:
                          url = sitemap['url']
                          action = sitemap.get('action', 'unknown')
                          
                          if action == 'healthy':
                              status_emoji = "‚úÖ"
                          elif 'error' in action.lower() or 'failed' in action.lower():
                              status_emoji = "‚ùå"
                          elif 'warning' in action.lower():
                              status_emoji = "‚ö†Ô∏è"
                          else:
                              status_emoji = "‚ÑπÔ∏è"
                          
                          report.append(f"### {status_emoji} {url}")
                          report.append(f"**Action:** {action}")
                          
                          if 'validation' in sitemap:
                              val = sitemap['validation']
                              report.append(f"**Validation:** {'‚úÖ Valid' if val['is_valid'] else '‚ùå Invalid'} - {val['message']}")
                          
                          if 'lastDownloaded' in sitemap:
                              report.append(f"**Last Downloaded:** {sitemap['lastDownloaded']}")
                          
                          if 'errors' in sitemap and sitemap['errors'] > 0:
                              report.append(f"**Errors:** {sitemap['errors']}")
                          
                          if 'warnings' in sitemap and sitemap['warnings'] > 0:
                              report.append(f"**Warnings:** {sitemap['warnings']}")
                          
                          report.append("")
                  
                  # Issues section
                  if self.results['issues_found']:
                      report.append("## ‚ùå Issues Found")
                      for issue in self.results['issues_found']:
                          report.append(f"- {issue}")
                      report.append("")
                  
                  # Fixes section
                  if self.results['fixes_applied']:
                      report.append("## ‚úÖ Fixes Applied")
                      for fix in self.results['fixes_applied']:
                          report.append(f"- {fix}")
                      report.append("")
                  
                  # Recommendations
                  if self.results['issues_found']:
                      report.append("## üí° Recommendations")
                      report.append("1. Monitor the issues listed above")
                      report.append("2. Check your sitemap XML files for validity")
                      report.append("3. Ensure all URLs in sitemaps are accessible")
                      report.append("4. Review Google Search Console for additional details")
                      report.append("")
                  
                  return "\n".join(report)
          
          def main():
              parser = argparse.ArgumentParser(description='Enhanced Sitemap Monitor')
              parser.add_argument('--site', required=True, help='Site URL (e.g., https://example.com/)')
              parser.add_argument('--sitemaps', required=True, nargs='+', help='Sitemap URLs to monitor')
              parser.add_argument('--force-resubmit', action='store_true', help='Force resubmit all sitemaps')
              parser.add_argument('--detailed-report', action='store_true', default=True, help='Generate detailed report')
              parser.add_argument('--service-account', default='service-account.json', help='Service account JSON file')
              parser.add_argument('--output-json', help='Output results to JSON file')
              parser.add_argument('--output-report', help='Output report to markdown file')
              
              args = parser.parse_args()
              
              print("üöÄ Enhanced Sitemap Monitor Starting...")
              print(f"‚è∞ Timestamp: {datetime.now(timezone.utc).isoformat()}")
              
              monitor = SitemapMonitor(args.service_account)
              results = monitor.monitor_sitemaps(args.site, args.sitemaps, args.force_resubmit)
              
              # Output JSON results
              if args.output_json:
                  with open(args.output_json, 'w') as f:
                      json.dump(results, f, indent=2)
                  print(f"üìÑ Results saved to: {args.output_json}")
              
              # Generate and output report
              report = monitor.generate_report(args.detailed_report)
              print("\n" + "="*80)
              print(report)
              
              if args.output_report:
                  with open(args.output_report, 'w') as f:
                      f.write(report)
                  print(f"üìÑ Report saved to: {args.output_report}")
              
              # Set exit code based on results
              if results['summary']['overall_status'] != 'healthy':
                  print(f"\n‚ùå Exiting with error code 1 - Issues detected")
                  sys.exit(1)
              else:
                  print(f"\n‚úÖ All sitemaps healthy - Exiting with code 0")
                  sys.exit(0)
          
          if __name__ == '__main__':
              main()
          EOF

      - name: Run Enhanced Sitemap Monitor
        id: sitemap_check
        run: |
          python enhanced_sitemap_monitor.py \
            --site "https://sednabcn.github.io/" \
            --sitemaps "https://sednabcn.github.io/sitemap.xml" \
            --output-json "sitemap-results.json" \
            --output-report "sitemap-report.md" \
            ${{ inputs.force_resubmit == 'true' && '--force-resubmit' || '' }} \
            ${{ inputs.detailed_report == 'false' && '--no-detailed-report' || '--detailed-report' }}
        continue-on-error: true

      - name: Upload Results as Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: sitemap-monitor-results-${{ github.run_number }}
          path: |
            sitemap-results.json
            sitemap-report.md
          retention-days: 30

      - name: Check Results and Set Status
        id: check_results
        run: |
          if [ -f "sitemap-results.json" ]; then
            # Extract summary from JSON
            ISSUES_COUNT=$(python -c "import json; data=json.load(open('sitemap-results.json')); print(data['summary']['issues_found'])")
            FIXES_COUNT=$(python -c "import json; data=json.load(open('sitemap-results.json')); print(data['summary']['fixes_applied'])")
            OVERALL_STATUS=$(python -c "import json; data=json.load(open('sitemap-results.json')); print(data['summary']['overall_status'])")
            
            echo "issues_count=$ISSUES_COUNT" >> $GITHUB_OUTPUT
            echo "fixes_count=$FIXES_COUNT" >> $GITHUB_OUTPUT
            echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
            
            if [ "$OVERALL_STATUS" = "healthy" ]; then
              echo "‚úÖ All sitemaps are healthy!"
              echo "status_emoji=‚úÖ" >> $GITHUB_OUTPUT
              echo "status_message=All sitemaps healthy" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Issues detected in sitemaps!"
              echo "status_emoji=‚ùå" >> $GITHUB_OUTPUT
              echo "status_message=Issues detected - check report" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Results file not found!"
            echo "status_emoji=üí•" >> $GITHUB_OUTPUT
            echo "status_message=Monitor script failed" >> $GITHUB_OUTPUT
            echo "issues_count=1" >> $GITHUB_OUTPUT
            echo "fixes_count=0" >> $GITHUB_OUTPUT
            echo "overall_status=error" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Issue on Problems
        if: steps.check_results.outputs.overall_status != 'healthy'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const issueTitle = 'üó∫Ô∏è Sitemap Monitor: Issues Detected';
            const issuesCount = '${{ steps.check_results.outputs.issues_count }}';
            const fixesCount = '${{ steps.check_results.outputs.fixes_count }}';
            
            let reportContent = '## Summary\nReport generation failed - check workflow logs.';
            
            try {
              reportContent = fs.readFileSync('sitemap-report.md', 'utf8');
            } catch (error) {
              console.log('Could not read report file:', error.message);
            }
            
            const issueBody = `${reportContent}

---
**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
**Triggered by:** ${{ github.event_name }}
**Issues Found:** ${issuesCount}
**Fixes Applied:** ${fixesCount}

> This issue was automatically created by the Enhanced Sitemap Monitor workflow.`;

            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['sitemap-monitor', 'automated']
            });
            
            const existingIssue = issues.data.find(issue => issue.title === issueTitle);
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['sitemap-monitor', 'automated', 'bug']
              });
              console.log('Created new sitemap monitor issue');
            }

      - name: Close Issue if All Healthy
        if: steps.check_results.outputs.overall_status == 'healthy'
        uses: actions/github-script@v6
        with:
          script: |
            const issueTitle = 'üó∫Ô∏è Sitemap Monitor: Issues Detected';
            
            // Find open sitemap monitor issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['sitemap-monitor', 'automated']
            });
            
            const existingIssue = issues.data.find(issue => issue.title === issueTitle);
            
            if (existingIssue) {
              // Close the issue with a success comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `‚úÖ **All sitemap issues have been resolved!**

The latest sitemap monitor run shows all sitemaps are now healthy.

**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
**Status:** All sitemaps healthy
**Fixes Applied:** ${{ steps.check_results.outputs.fixes_count }}

Automatically closing this issue.`
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                state: 'closed'
              });
              console.log(`Closed resolved issue #${existingIssue.number}`);
            }

      - name: Update Repository Status Badge
        run: |
>>>>>>> 509206bbc14ec3658bf0dde3eef59956659e6234
          mkdir -p .github/badges
          STATUS_EMOJI="${{ steps.check_results.outputs.status_emoji }}"
          STATUS_MESSAGE="${{ steps.check_results.outputs.status_message }}"
          
          cat > .github/badges/sitemap-status.json << EOF
          {
            "schemaVersion": 1,
            "label": "sitemap status",
            "message": "$STATUS_MESSAGE",
            "color": "${{ steps.check_results.outputs.overall_status == 'healthy' && 'brightgreen' || 'red' }}",
            "namedLogo": "google",
            "logoColor": "white"
          }
          EOF
          
          echo "Created status badge with: $STATUS_EMOJI $STATUS_MESSAGE"

      - name: Commit Status Updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -f ".github/badges/sitemap-status.json" ]; then
            git add .github/badges/sitemap-status.json
          fi
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üó∫Ô∏è Update sitemap status badge - ${{ steps.check_results.outputs.status_message }}"
            git push
            echo "Committed status updates"
          fi

      - name: Summary
        run: |
          echo "## üó∫Ô∏è Sitemap Monitor Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.check_results.outputs.status_emoji }} **Status:** ${{ steps.check_results.outputs.status_message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Issues Found:** ${{ steps.check_results.outputs.issues_found || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Fixes Applied:** ${{ steps.check_results.outputs.fixes_applied || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "sitemap-report.md" ]; then
            echo "### üìã Detailed Report" >> $GITHUB_STEP_SUMMARY
            cat sitemap-report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send Slack/Teams Notification (if configured)
        if: steps.check_results.outputs.overall_status != 'healthy'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"üö® Sitemap Issues Detected\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"üó∫Ô∏è Sitemap Monitor Alert\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Site:* https://sednabcn.github.io/\\n*Status:* ${{ steps.check_results.outputs.status_message }}\\n*Issues:* ${{ steps.check_results.outputs.issues_count }}\\n*Fixes Applied:* ${{ steps.check_results.outputs.fixes_count }}\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"View Workflow\"
                      },
                      \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                    }
                  ]
                }
              ]
            }" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
            echo "Slack notification sent"
          fi

      - name: Performance and SEO Analysis
        run: |
          cat > seo_analysis.py << 'EOF'
          #!/usr/bin/env python3
          import requests
          import json
          from urllib.parse import urljoin, urlparse
          import xml.etree.ElementTree as ET
          from datetime import datetime, timezone
          import time

          def analyze_sitemap_seo(sitemap_url, max_urls=50):
              """Analyze sitemap for SEO best practices"""
              print(f"üîç Analyzing SEO aspects of sitemap: {sitemap_url}")
              
              try:
                  response = requests.get(sitemap_url, timeout=30)
                  if response.status_code != 200:
                      return {"error": f"Failed to fetch sitemap: {response.status_code}"}
                  
                  root = ET.fromstring(response.content)
                  urls = []
                  
                  # Extract URLs from sitemap
                  for url_elem in root.findall('.//{http://www.sitemaps.org/schemas/sitemap/0.9}url'):
                      loc_elem = url_elem.find('{http://www.sitemaps.org/schemas/sitemap/0.9}loc')
                      lastmod_elem = url_elem.find('{http://www.sitemaps.org/schemas/sitemap/0.9}lastmod')
                      priority_elem = url_elem.find('{http://www.sitemaps.org/schemas/sitemap/0.9}priority')
                      changefreq_elem = url_elem.find('{http://www.sitemaps.org/schemas/sitemap/0.9}changefreq')
                      
                      if loc_elem is not None:
                          url_data = {
                              'url': loc_elem.text,
                              'lastmod': lastmod_elem.text if lastmod_elem is not None else None,
                              'priority': priority_elem.text if priority_elem is not None else None,
                              'changefreq': changefreq_elem.text if changefreq_elem is not None else None
                          }
                          urls.append(url_data)
                  
                  analysis = {
                      'total_urls': len(urls),
                      'urls_with_lastmod': sum(1 for u in urls if u['lastmod']),
                      'urls_with_priority': sum(1 for u in urls if u['priority']),
                      'urls_with_changefreq': sum(1 for u in urls if u['changefreq']),
                      'recommendations': []
                  }
                  
                  # Generate recommendations
                  if analysis['urls_with_lastmod'] < len(urls) * 0.8:
                      analysis['recommendations'].append("Consider adding <lastmod> tags to more URLs")
                  
                  if analysis['urls_with_priority'] < len(urls) * 0.5:
                      analysis['recommendations'].append("Consider adding <priority> tags to important URLs")
                  
                  if len(urls) > 50000:
                      analysis['recommendations'].append("Sitemap has >50k URLs, consider splitting into multiple sitemaps")
                  
                  # Sample URL analysis (limit to avoid timeout)
                  sample_urls = urls[:min(max_urls, len(urls))]
                  accessible_count = 0
                  
                  for i, url_data in enumerate(sample_urls):
                      try:
                          url_response = requests.head(url_data['url'], timeout=10, allow_redirects=True)
                          if 200 <= url_response.status_code < 400:
                              accessible_count += 1
                          time.sleep(0.1)  # Rate limiting
                      except:
                          pass
                      
                      if i % 10 == 0:
                          print(f"Checked {i+1}/{len(sample_urls)} URLs...")
                  
                  analysis['sample_size'] = len(sample_urls)
                  analysis['accessible_urls'] = accessible_count
                  analysis['accessibility_rate'] = (accessible_count / len(sample_urls)) * 100 if sample_urls else 0
                  
                  if analysis['accessibility_rate'] < 95:
                      analysis['recommendations'].append(f"Some URLs may not be accessible ({analysis['accessibility_rate']:.1f}% accessible)")
                  
                  return analysis
                  
              except Exception as e:
                  return {"error": f"Analysis failed: {str(e)}"}

          # Run analysis
          result = analyze_sitemap_seo("https://sednabcn.github.io/sitemap.xml", max_urls=20)
          
          print("\n" + "="*50)
          print("SEO ANALYSIS RESULTS")
          print("="*50)
          
          if "error" in result:
              print(f"‚ùå Error: {result['error']}")
          else:
              print(f"üìä Total URLs: {result['total_urls']}")
              print(f"üìÖ URLs with lastmod: {result['urls_with_lastmod']}")
              print(f"‚≠ê URLs with priority: {result['urls_with_priority']}")
              print(f"üîÑ URLs with changefreq: {result['urls_with_changefreq']}")
              print(f"üåê Sample accessibility rate: {result['accessibility_rate']:.1f}% ({result['accessible_urls']}/{result['sample_size']})")
              
              if result['recommendations']:
                  print("\nüí° Recommendations:")
                  for rec in result['recommendations']:
                      print(f"  - {rec}")
              else:
                  print("\n‚úÖ No SEO recommendations - sitemap looks good!")
          
          # Save results
          with open('seo-analysis.json', 'w') as f:
              json.dump(result, f, indent=2)
          
          EOF
          
          python seo_analysis.py

      - name: Generate Health Check Badge
        run: |
          # Create a comprehensive health score
          ISSUES=${{ steps.check_results.outputs.issues_count || 0 }}
          
          if [ "$ISSUES" -eq 0 ]; then
            HEALTH_SCORE=100
            HEALTH_COLOR="brightgreen"
            HEALTH_MESSAGE="Excellent"
          elif [ "$ISSUES" -le 2 ]; then
            HEALTH_SCORE=85
            HEALTH_COLOR="green"
            HEALTH_MESSAGE="Good"
          elif [ "$ISSUES" -le 5 ]; then
            HEALTH_SCORE=70
            HEALTH_COLOR="yellow"
            HEALTH_MESSAGE="Fair"
          else
            HEALTH_SCORE=40
            HEALTH_COLOR="red"
            HEALTH_MESSAGE="Poor"
          fi
          
          mkdir -p .github/badges
          cat > .github/badges/sitemap-health.json << EOF
          {
            "schemaVersion": 1,
            "label": "sitemap health",
            "message": "$HEALTH_MESSAGE ($HEALTH_SCORE%)",
            "color": "$HEALTH_COLOR"
          }
          EOF
          
          echo "Generated health badge: $HEALTH_MESSAGE ($HEALTH_SCORE%)"

      - name: Update README with Status
        run: |
          if [ -f "README.md" ]; then
            # Update or add sitemap status section
            if grep -q "<!-- SITEMAP_STATUS_START -->" README.md; then
              # Update existing section
              sed -i '/<!-- SITEMAP_STATUS_START -->/,/<!-- SITEMAP_STATUS_END -->/c\
          <!-- SITEMAP_STATUS_START -->\
          ## üó∫Ô∏è Sitemap Status\
          \
          ![Sitemap Status](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ github.repository }}/main/.github/badges/sitemap-status.json)\
          ![Health Score](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ github.repository }}/main/.github/badges/sitemap-health.json)\
          \
          **Last Checked:** $(date -u +"%Y-%m-%d %H:%M UTC")\
          **Issues:** ${{ steps.check_results.outputs.issues_count || 0 }}\
          **Status:** ${{ steps.check_results.outputs.status_message }}\
          \
          > Automatically updated by [Sitemap Monitor](.github/workflows/sitemap-monitor.yml)\
          <!-- SITEMAP_STATUS_END -->' README.md
            else
              # Add new section at the end
              echo "" >> README.md
              echo "<!-- SITEMAP_STATUS_START -->" >> README.md
              echo "## üó∫Ô∏è Sitemap Status" >> README.md
              echo "" >> README.md
              echo "![Sitemap Status](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ github.repository }}/main/.github/badges/sitemap-status.json)" >> README.md
              echo "![Health Score](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ github.repository }}/main/.github/badges/sitemap-health.json)" >> README.md
              echo "" >> README.md
              echo "**Last Checked:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> README.md
              echo "**Issues:** ${{ steps.check_results.outputs.issues_count || 0 }}" >> README.md
              echo "**Status:** ${{ steps.check_results.outputs.status_message }}" >> README.md
              echo "" >> README.md
              echo "> Automatically updated by [Sitemap Monitor](.github/workflows/sitemap-monitor.yml)" >> README.md
              echo "<!-- SITEMAP_STATUS_END -->" >> README.md
            fi
            echo "Updated README.md with sitemap status"
          fi

      - name: Historical Tracking
        run: |
          mkdir -p .github/sitemap-history
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          
          # Create historical record
          cat > .github/sitemap-history/${TIMESTAMP}.json << EOF
          {
            "timestamp": "$(date -u --iso-8601=seconds)",
            "run_number": ${{ github.run_number }},
            "status": "${{ steps.check_results.outputs.overall_status }}",
            "issues_count": ${{ steps.check_results.outputs.issues_count || 0 }},
            "fixes_count": ${{ steps.check_results.outputs.fixes_count || 0 }},
            "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          
          # Keep only last 30 days of history (approximately)
          find .github/sitemap-history -name "*.json" -type f -mtime +30 -delete 2>/dev/null || true
          
          echo "Created historical record: ${TIMESTAMP}.json"

      - name: Commit All Updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Sitemap Monitor Bot"
          
          # Add all generated files
          git add .github/badges/ 2>/dev/null || true
          git add .github/sitemap-history/ 2>/dev/null || true
          git add README.md 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üó∫Ô∏è Sitemap Monitor Update - ${{ steps.check_results.outputs.status_message }}

            - Status: ${{ steps.check_results.outputs.status_message }}
            - Issues: ${{ steps.check_results.outputs.issues_count || 0 }}
            - Fixes: ${{ steps.check_results.outputs.fixes_count || 0 }}
            - Run: #${{ github.run_number }}
            
            Auto-generated by sitemap-monitor workflow"
            
            git push
            echo "‚úÖ Committed and pushed all updates"
          fi

      - name: Final Status Check
        run: |
          echo "üèÅ FINAL SITEMAP MONITOR RESULTS"
          echo "================================="
          echo "Status: ${{ steps.check_results.outputs.status_emoji }} ${{ steps.check_results.outputs.status_message }}"
          echo "Issues Found: ${{ steps.check_results.outputs.issues_count || 0 }}"
          echo "Fixes Applied: ${{ steps.check_results.outputs.fixes_count || 0 }}"
          echo "Overall Health: ${{ steps.check_results.outputs.overall_status }}"
          echo ""
          
          if [ "${{ steps.check_results.outputs.overall_status }}" != "healthy" ]; then
            echo "‚ö†Ô∏è  ATTENTION REQUIRED: Issues were detected in your sitemaps"
            echo "üìã Check the generated issue for detailed information"
            echo "üîó Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            exit 1
          else
            echo "‚úÖ All systems green! Your sitemaps are healthy and properly submitted to Google"
            exit 0
          fi

      - name: Cleanup Sensitive Files
        if: always()
        run: |
          rm -f service-account.json
          rm -f enhanced_sitemap_monitor.py
          rm -f seo_analysis.py
          echo "üßπ Cleaned up sensitive and temporary files"
