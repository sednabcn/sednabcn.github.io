name: Monitor Google Indexing Status

on:
  schedule:
    - cron: '0 8 * * 1,4' # Run twice weekly (Monday and Thursday at 8:00 UTC)
  workflow_dispatch: # Allow manual triggering

jobs:
  check-indexing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client
          pip install google-auth-oauthlib
          pip install google-auth-httplib2

      - name: Write credentials to file
        run: |
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT }}' > service-account.json
        
      - name: Check indexing status
        run: |
          python .github/scripts/monitor_indexing_status.py --site https://sednabcn.github.io/ --output indexing_status.json
        
      - name: Send email notification
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.email == 'true' }}
        run: |
          python .github/scripts/monitor_indexing_status.py --site https://sednabcn.github.io/ --email ${{ secrets.NOTIFICATION_EMAIL }}
        env:
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          SMTP_SERVER: smtp.gmail.com
          SMTP_PORT: 587
          
      - name: Upload indexing status report
        uses: actions/upload-artifact@v3
        with:
          name: indexing-status-report
          path: indexing_status.json
          retention-days: 90
          
      - name: Create issue on errors
        if: always()
        run: |
          if [ -f indexing_status.json ]; then
            ERRORS=$(jq '.crawl_errors' indexing_status.json)
            if [ "$ERRORS" -gt 0 ]; then
              gh issue create --title "Google Indexing Errors Detected" --body "Google indexing errors were detected. See the workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}